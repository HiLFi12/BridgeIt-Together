# Sistema de Canvas de Fin de Juego - GameConditionManager

## üìã Resumen de Funcionalidades

Se ha implementado un sistema completo para manejar el fin de juego que incluye:

1. **Desactivaci√≥n autom√°tica del AutoGenerator**
2. **Desactivaci√≥n autom√°tica del PlayerController**
3. **Activaci√≥n autom√°tica de Canvas de Victoria/Derrota**
4. **Sistema de reinicio que reactiva todos los componentes**
5. **Animaciones de Victoria y Derrota para personajes** ‚Üê NUEVO
6. **Configuraci√≥n autom√°tica de botones de fin de juego** ‚Üê NUEVO

---

## üéØ Caracter√≠sticas Principales

### ‚úÖ Control de Sistemas de Juego
- **AutoGenerator**: Se desactiva autom√°ticamente cuando el juego termina
- **PlayerController**: Se desactivan todos los PlayerController en la escena
- **Reactivaci√≥n**: Al reiniciar el juego, todos los sistemas se reactivan autom√°ticamente

### üé≠ Sistema de Animaciones de Fin de Juego ‚Üê NUEVO
- **Animaciones de Victoria**: Se activan autom√°ticamente en todos los PlayerAnimator al ganar
- **Animaciones de Derrota**: Se activan autom√°ticamente en todos los PlayerAnimator al perder
- **Bloqueo de movimiento**: Las animaciones normales se bloquean durante el fin de juego
- **Reinicio autom√°tico**: Las animaciones vuelven al estado normal al reiniciar

### üñºÔ∏è Canvas de Fin de Juego
- **Canvas de Victoria**: Se instancia autom√°ticamente cuando se gana
- **Canvas de Derrota**: Se instancia autom√°ticamente cuando se pierde
- **Gesti√≥n autom√°tica**: Los canvas anteriores se destruyen al reiniciar

### üîß Configuraci√≥n Flexible
- **Desactivaci√≥n opcional**: Puedes elegir qu√© sistemas desactivar
- **Prefabs configurables**: Asigna tus propios canvas prefabs
- **Auto-configuraci√≥n**: Sistema autom√°tico para encontrar prefabs

### üéÆ Sistema de Navegaci√≥n Simplificado ‚Üê FINAL + PAUSA
- **Botones MenuButton**: Los prefabs de canvas deben tener botones con MenuButton ya configurado
- **Configuraci√≥n manual**: Cada bot√≥n debe tener su NavigationType configurado manualmente en el prefab
- **Tipos disponibles**:
  - `NextLevel` - Navega al siguiente nivel (configurable en GameConditionManager)
  - `RestartLevel` - Reinicia el nivel actual
  - `MenuFromGame` - Va al men√∫ principal desde el juego
  - `LevelSelectFromGame` - Carga la escena Menu que autom√°ticamente muestra LevelSelector
  - `ResumeGame` - Reanuda el juego desde el men√∫ de pausa (solo para canvas de pausa)
### üéÆ Sistema de Pausa

**Activaci√≥n:** ESC en cualquier momento durante el juego
**Funcionalidad:** Pausa completa del juego (Time.timeScale = 0) y mostrar men√∫ de pausa

#### Caracter√≠sticas T√©cnicas:
- **Canvas en escena:** El canvas de pausa debe existir en la escena del juego (NO es un prefab)
- **Sistema SetActive:** Usa el mismo patr√≥n que el men√∫ principal (SetActive true/false)
- **NO instancia/destruye:** Como los canvas del men√∫, solo activa/desactiva
- **Configuraci√≥n simple:** Asignar el Canvas directamente en el inspector de GameConditionManager

#### Botones Disponibles:
- **Reanudar:** Contin√∫a el juego (NavigationType.ResumeGame)
- **Men√∫ Principal:** Va al men√∫ principal con MainMenu activo (NavigationType.MenuFromGame)

#### Configuraci√≥n:
1. **Canvas de pausa:** Debe existir en la escena del juego (inicialmente desactivado)
2. **Asignaci√≥n:** Asignar en el campo `pauseCanvas` del GameConditionManager
3. **Botones:** Los botones deben tener MenuButton con NavigationType configurado
   - `ResumeGame` para el bot√≥n de reanudar
   - `MenuFromGame` para ir al men√∫ principal (aparecer√° con MainMenu activo)

#### Integraci√≥n:
- Se integra autom√°ticamente con `GameConditionManager`
- Los triggers y condiciones de juego se suspenden durante la pausa
- Los botones usan el sistema `MenuButton` est√°ndar
- **NavigationType.MenuFromGame:** Carga la escena Menu con MainMenu activo
- **NavigationType.LevelSelectFromGame:** Carga la escena Menu con LevelSelector activo
- **Sistema simplificado**: 
  - Sin PlayerPrefs, sin preferencias, sin l√≥gica compleja
  - La escena Menu siempre inicia con LevelSelector activo por defecto
  - Auto-asignaci√≥n b√°sica de canvas por nombre
- **Verificaci√≥n autom√°tica**: El sistema verifica que los botones est√©n configurados correctamente

---

## üöÄ C√≥mo Usar

### M√©todo 1: Configuraci√≥n Manual de Prefabs (Recomendado)

1. **Crear Victory Canvas:**
   - Crea un Canvas ‚Üí UI ‚Üí Canvas
   - Agrega botones seg√∫n necesites (Next Level, Restart, Menu, Level Select)
   - **En cada bot√≥n:**
     - Agrega el componente `MenuButton.cs`
     - Configura el `NavigationType` apropiado:
       - `NextLevel` para el bot√≥n de siguiente nivel
       - `RestartLevel` para el bot√≥n de reiniciar
       - `MenuFromGame` para el bot√≥n de men√∫
       - `LevelSelectFromGame` para el bot√≥n de selector de niveles

2. **Crear Defeat Canvas:**
   - Igual que el Victory Canvas
   - Configura los mismos tipos de botones seg√∫n necesites

3. **Convertir a Prefabs:**
   - Arrastra ambos canvas a la carpeta Assets/Prefabs
   - Borra los canvas de la escena

4. **Configurar GameConditionManager:**
   - Asigna los prefabs a los campos `victoryCanvasPrefab` y `defeatCanvasPrefab`

**¬°El sistema funcionar√° autom√°ticamente!**

### M√©todo 2: Configuraci√≥n Avanzada (Opcional)

Si quieres personalizar nombres de escenas o comportamientos espec√≠ficos:

1. **NavigationType.Custom:**
   - Usa `Custom` como NavigationType
   - Especifica el nombre de la escena en el campo `customSceneName`

2. **Verificaci√≥n autom√°tica:**
   - El sistema verificar√° que los botones est√©n configurados correctamente
   - Ver√°s mensajes en la consola indicando el estado de cada bot√≥n

---

## ‚öôÔ∏è Tipos de Navegaci√≥n Disponibles

### Para Fin de Juego:
- **`NextLevel`**: Navega al siguiente nivel (actualmente recarga el nivel)
- **`RestartLevel`**: Reinicia el nivel actual
- **`MenuFromGame`**: Va al men√∫ principal desde el juego  
- **`LevelSelectFromGame`**: Va al selector de niveles con PrehistoricLevels activo

### Tipos Generales (tambi√©n disponibles):
- **`MainMenu`**: Va al men√∫ principal
- **`LevelSelector`**: Va al selector de niveles general
- **`Custom`**: Carga una escena espec√≠fica (requiere `customSceneName`)

---

## üîß Configuraci√≥n del Sistema

### Archivo de Configuraci√≥n:
```
   // Agregar GameConditionCanvasSetup a cualquier GameObject en la escena
   GameObject setupObject = new GameObject("GameCondition Setup");
   setupObject.AddComponent<GameConditionCanvasSetup>();
   ```

2. **Configurar en el Inspector**:
   - Asignar `Victory Canvas Prefab` ‚Üí `Assets/Prefabs/GameConditions/Victory.prefab`
   - Asignar `Defeat Canvas Prefab` ‚Üí `Assets/Prefabs/GameConditions/Defeat.prefab`
   - Marcar `Configurar Automaticamente Al Iniciar` ‚úÖ
   - Marcar `Buscar Prefabs Automaticamente` ‚úÖ

### M√©todo 2: Configuraci√≥n Manual

```csharp
// Obtener referencia al GameConditionManager
GameConditionManager gameManager = GameConditionManager.Instance;

// Cargar los prefabs
GameObject victoryPrefab = Resources.Load<GameObject>("Victory");
GameObject defeatPrefab = Resources.Load<GameObject>("Defeat");

// Configurar canvas prefabs
gameManager.ConfigurarCanvasPrefabs(victoryPrefab, defeatPrefab);

// Configurar opciones de desactivaci√≥n
gameManager.ConfigurarDesactivacionSistemas(true, true); // Player, AutoGenerator
```

---

## ‚öôÔ∏è Nuevos Campos en GameConditionManager

### Inspector - Secci√≥n "Canvas de Fin de Juego"
- **Victory Canvas Prefab**: Prefab del canvas que se muestra al ganar
- **Defeat Canvas Prefab**: Prefab del canvas que se muestra al perder

### Inspector - Secci√≥n "Control de Jugador"
- **Desactivar Player Controller En Fin De Juego**: ‚úÖ Por defecto
- **Desactivar Auto Generator En Fin De Juego**: ‚úÖ Por defecto
- **Activar Animaciones Fin De Juego**: ‚úÖ Por defecto ‚Üê NUEVO

---

## üé≠ Par√°metros Requeridos en Animator Controller

Para que las animaciones funcionen correctamente, tu Animator Controller debe tener estos par√°metros:

### Par√°metros Obligatorios para Animaciones de Fin de Juego:
- **TriggerVictory** (Trigger): Activa la animaci√≥n de victoria
- **TriggerDefeat** (Trigger): Activa la animaci√≥n de derrota
- **IsGameEnded** (Bool): Indica si el juego ha terminado

### Par√°metros Normales de Gameplay:
- **Speed** (Float): Velocidad de movimiento del personaje
- **IsHolding** (Bool): Si est√° sosteniendo un objeto
- **IsBuilding** (Bool): Si est√° construyendo
- **TriggerBuild** (Trigger): Animaci√≥n de construcci√≥n
- **TriggerDrop** (Trigger): Animaci√≥n de soltar objeto

### Estados Recomendados en el Animator:
1. **Idle** ‚Üí Estado base
2. **Running** ‚Üí Cuando Speed > 0.1
3. **Victory** ‚Üí Activado por TriggerVictory
4. **Defeat** ‚Üí Activado por TriggerDefeat
5. **Building** ‚Üí Activado por IsBuilding
6. **Holding** ‚Üí Modificador cuando IsHolding = true

---

## üîç M√©todos Nuevos Disponibles

### Configuraci√≥n
```csharp
// Configurar canvas prefabs
gameManager.ConfigurarCanvasPrefabs(victoryPrefab, defeatPrefab);

// Configurar desactivaci√≥n de sistemas
gameManager.ConfigurarDesactivacionSistemas(bool player, bool autoGen);
```

### Control Manual de Sistemas
```csharp
// Desactivar sistemas manualmente
gameManager.DesactivarSistemasDeJuego();

// Reactivar sistemas manualmente
gameManager.ReactivarSistemasDeJuego();

// Activar canvas espec√≠ficos
gameManager.ActivarCanvasVictoria();
gameManager.ActivarCanvasDerrota();

// Controlar animaciones espec√≠ficas ‚Üê NUEVO
gameManager.ActivarAnimacionesVictoria();
gameManager.ActivarAnimacionesDerrota();
```

### Control de Animaciones PlayerAnimator ‚Üê NUEVO
```csharp
// Obtener referencia al PlayerAnimator
PlayerAnimator playerAnimator = GetComponent<PlayerAnimator>();

// Activar animaci√≥n de victoria
playerAnimator.TriggerVictoryAnimation();

// Activar animaci√≥n de derrota
playerAnimator.TriggerDefeatAnimation();

// Reiniciar a estado de gameplay
playerAnimator.ResetToGameplayState();

// Verificar estados
bool gameEnded = playerAnimator.IsGameEnded();
bool inVictory = playerAnimator.IsInVictoryState();
bool inDefeat = playerAnimator.IsInDefeatState();
```

### Configuraci√≥n de Botones de Fin de Juego ‚Üê NUEVO
```csharp
// Los botones se configuran autom√°ticamente si tienen estos nombres:
// - "NextLevelButton" ‚Üí Navegaci√≥n al siguiente nivel
// - "RestartButton" ‚Üí Reiniciar nivel actual
// - "MenuButton" ‚Üí Ir al men√∫ principal
// - "LevelSelectButton" ‚Üí Ir al selector de niveles (PrehistoricLevels)

// Configuraci√≥n manual de un bot√≥n espec√≠fico
MenuButton menuButton = GetComponent<MenuButton>();
menuButton.SetNavigationType(MenuButton.NavigationType.NextLevel);
```

### Testing (Context Menu)
- **Test - Activar Canvas Victoria**
- **Test - Activar Canvas Derrota**
- **Test - Desactivar Sistemas**
- **Test - Reactivar Sistemas**
- **Test - Activar Animaci√≥n Victoria** ‚Üê NUEVO
- **Test - Activar Animaci√≥n Derrota** ‚Üê NUEVO
- **Test - Reiniciar Animaciones** ‚Üê NUEVO

---

## üìÅ Estructura de Archivos Recomendada

```
Assets/
‚îú‚îÄ‚îÄ Prefabs/
‚îÇ   ‚îî‚îÄ‚îÄ GameConditions/
‚îÇ       ‚îú‚îÄ‚îÄ Victory.prefab    ‚Üê Canvas de victoria
‚îÇ       ‚îî‚îÄ‚îÄ Defeat.prefab     ‚Üê Canvas de derrota
‚îú‚îÄ‚îÄ Scripts/
‚îÇ   ‚îú‚îÄ‚îÄ Game/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ GameConditionManager.cs              ‚Üê Script principal (modificado)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ GameConditionCanvasSetup.cs          ‚Üê Script helper (nuevo)
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ EndGameCanvasButtonConfigurator.cs   ‚Üê Configurador de botones (nuevo)
‚îÇ   ‚îú‚îÄ‚îÄ Player/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ PlayerAnimator.cs                    ‚Üê Script de animaciones (modificado)
‚îÇ   ‚îî‚îÄ‚îÄ Navigation/
‚îÇ       ‚îî‚îÄ‚îÄ MenuButton.cs                        ‚Üê Navegaci√≥n de botones (modificado)
‚îî‚îÄ‚îÄ Animations/
    ‚îî‚îÄ‚îÄ Player/
        ‚îú‚îÄ‚îÄ PlayerAnimatorController.controller ‚Üê Animator Controller con par√°metros
        ‚îú‚îÄ‚îÄ VictoryAnimation.anim              ‚Üê Animaci√≥n de victoria
        ‚îî‚îÄ‚îÄ DefeatAnimation.anim               ‚Üê Animaci√≥n de derrota
```

---

## üß™ Testing y Debugging

### Context Menu en GameConditionManager
```
- Simular Veh√≠culo Pasa
- Simular Veh√≠culo Cae
- Reiniciar Juego
- Mostrar Estado Actual
- Simular Fin de Rondas
- Test - Activar Canvas Victoria    ‚Üê NUEVO
- Test - Activar Canvas Derrota     ‚Üê NUEVO
- Test - Desactivar Sistemas        ‚Üê NUEVO
- Test - Reactivar Sistemas         ‚Üê NUEVO
```

### Context Menu en GameConditionCanvasSetup
```
- Configurar GameConditionManager
- Buscar Prefabs Autom√°ticamente
- Test - Simular Victoria
- Test - Simular Derrota
- Test - Mostrar Estado
```

---

## üêõ Soluci√≥n de Problemas

### ‚ùì Los canvas no aparecen
**Soluci√≥n**: Verificar que los prefabs est√©n asignados en el Inspector
```csharp
// Verificar en el log
Debug.Log("Victory Prefab: " + (victoryCanvasPrefab != null ? victoryCanvasPrefab.name : "NULL"));
```

### ‚ùì Los sistemas no se desactivan
**Soluci√≥n**: Verificar que las opciones de desactivaci√≥n est√©n habilitadas
```csharp
// Verificar configuraci√≥n
Debug.Log($"Desactivar Player: {desactivarPlayerControllerEnFinDeJuego}");
Debug.Log($"Desactivar AutoGen: {desactivarAutoGeneratorEnFinDeJuego}");
```

### ‚ùì El PlayerController no se encuentra
**Soluci√≥n**: El sistema busca autom√°ticamente todos los PlayerController al iniciar
```csharp
// Verificar en el log al iniciar
Debug.Log($"PlayerControllers encontrados: {playerControllers?.Length ?? 0}");
```

### ‚ùì Las animaciones no cambian
**Soluci√≥n**: Verificar que el Animator Controller tenga los par√°metros correctos
```csharp
// Verificar en PlayerAnimator que los par√°metros existen
// Los warnings aparecer√°n en la consola si faltan par√°metros
```

### ‚ùì El personaje sigue corriendo despu√©s de ganar/perder
**Soluci√≥n**: Verificar que `activarAnimacionesFinDeJuego` est√© habilitado
```csharp
// Verificar configuraci√≥n en GameConditionManager
Debug.Log($"Activar Animaciones: {activarAnimacionesFinDeJuego}");
```

### ‚ùì Las animaciones no se reinician al reiniciar el juego
**Soluci√≥n**: El sistema autom√°ticamente llama ResetToGameplayState()
```csharp
// Verificar en el log que se ejecuta el reinicio
Debug.Log("üîÑ PlayerAnimator(s) reiniciado(s) a estado de gameplay");
```

### üîß Troubleshooting

### Problema: Canvas de Pausa No Aparece

**S√≠ntomas:** Al presionar ESC el juego se pausa pero no se ve el men√∫ de pausa

**Soluciones aplicadas autom√°ticamente:**
- El sistema fuerza el Canvas a modo ScreenSpaceOverlay
- Configura un Sorting Order alto (1000) autom√°ticamente  
- Verifica y activa componentes Canvas y CanvasGroup
- Hace refresh forzado del Canvas
- Asegura que GameObject est√© activo en jerarqu√≠a

**Verificaci√≥n manual:**
1. Aseg√∫rate de que `pauseCanvasPrefab` est√© asignado en GameConditionManager
2. Verifica que el prefab tenga un componente Canvas
3. Habilita `mostrarDebugInfo` en GameConditionManager para ver logs detallados

### Problema: Botones de Pausa No Funcionan

**Verificaci√≥n:**
1. Los botones deben tener componente MenuButton
2. NavigationType debe ser `ResumeGame` o `MenuFromGame`
3. No usar botones Unity Button sin MenuButton

---

## üéÆ Flujo de Funcionamiento

1. **Inicio del Juego**:
   - Se buscan autom√°ticamente todos los PlayerController
   - Se configura el sistema seg√∫n los par√°metros del Inspector

2. **Durante el Juego**:
   - Los sistemas funcionan normalmente
   - Los triggers de victoria/derrota est√°n activos

3. **Fin del Juego** (Victoria o Derrota):
   - Se desactiva el AutoGenerator (si est√° configurado)
   - Se desactivan todos los PlayerController (si est√° configurado)
   - Se activan las animaciones de victoria/derrota en todos los PlayerAnimator ‚Üê NUEVO
   - Se instancia y activa el canvas correspondiente
   - Se disparan los eventos OnVictoria/OnDerrota

4. **Reinicio del Juego**:
   - Se reactivan todos los sistemas desactivados
   - Se reinician las animaciones a estado de gameplay ‚Üê NUEVO
   - Se destruye el canvas de fin de juego
   - Se resetean todos los contadores
   - El juego vuelve al estado original

---

## ‚ú® Beneficios del Nuevo Sistema

- üéØ **Autom√°tico**: No requiere c√≥digo adicional en otros scripts
- üîß **Configurable**: Puedes elegir qu√© desactivar y qu√© canvas usar
- üß™ **Testeable**: M√©todos de testing integrados
- üöÄ **F√°cil de usar**: Setup autom√°tico con script helper
- üîÑ **Reversible**: El reinicio restaura todo al estado original
- üì± **Escalable**: Funciona con m√∫ltiples PlayerController autom√°ticamente
- üé≠ **Animaciones integradas**: Control autom√°tico de animaciones de victoria/derrota ‚Üê NUEVO
- üéØ **Bloqueo inteligente**: Las animaciones normales se bloquean durante el fin de juego ‚Üê NUEVO

¬°El sistema est√° listo para usar! Solo necesitas:
1. Asignar los prefabs de canvas en el Inspector
2. Configurar los par√°metros en tu Animator Controller
3. ¬°Todo funcionar√° autom√°ticamente! üéâ

## üéÆ Gu√≠a R√°pida de Configuraci√≥n del Animator

### Pasos para configurar las animaciones:

1. **Abrir tu Animator Controller**
2. **Agregar los par√°metros requeridos**:
   - `TriggerVictory` (Trigger)
   - `TriggerDefeat` (Trigger) 
   - `IsGameEnded` (Bool)
3. **Crear los estados de animaci√≥n**:
   - Estado `Victory` con tu animaci√≥n de victoria
   - Estado `Defeat` con tu animaci√≥n de derrota
4. **Configurar las transiciones**:
   - Desde `Any State` ‚Üí `Victory` cuando `TriggerVictory`
   - Desde `Any State` ‚Üí `Defeat` cuando `TriggerDefeat`
   - Condiciones adicionales: `IsGameEnded == true`
5. **¬°Listo!** El sistema manejar√° todo autom√°ticamente

## üéØ Sistema de Estado Inicial del Men√∫

### Funcionamiento:
El sistema permite configurar qu√© canvas del men√∫ debe estar activo cuando se carga la escena Menu desde el juego.

### M√©todos Disponibles:
- **NavigateToMainMenuFromGame():** Carga Menu con MainMenu activo
- **NavigateToLevelSelectorFromGame():** Carga Menu con LevelSelector activo

### Configuraci√≥n Autom√°tica por NavigationType:
- **MenuFromGame:** Autom√°ticamente usa MainMenu como estado inicial
- **LevelSelectFromGame:** Autom√°ticamente usa LevelSelector como estado inicial

### Comportamiento por Defecto:
- Si no se especifica estado inicial, el men√∫ iniciar√° con LevelSelector activo
- El estado inicial se limpia autom√°ticamente despu√©s de cada carga de Menu

---
